# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/configuration-reference
version: 2.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/jobs-steps/#jobs-overview & https://circleci.com/docs/configuration-reference/#jobs
jobs:
  notify-discord:
    # Specify the execution environment. You can specify an image from Docker Hub or use one of our convenience images from CircleCI's Developer Hub.
    # See: https://circleci.com/docs/executor-intro/ & https://circleci.com/docs/configuration-reference/#executor-job
    docker:
      - image: cimg/base:current

    # Add steps to the job
    # See: https://circleci.com/docs/jobs-steps/#steps-overview & https://circleci.com/docs/configuration-reference/#steps
    steps:
      # Checkout the code as the first step.
      - checkout
      - run:
          name: "Send Discord Notification"
          command: |
            curl -H "Content-Type: application/json" \
            -d '{
                  "username": "Delta Updates",
                  "embeds": [{
                    "title": "New Pipeline Execution",
                    "description": "Event Type: $CIRCLE_EVENT_TYPE",
                    "color": 15258703,
                    "fields": [
                      {
                        "name": "Repository",
                        "value": "$CIRCLE_PROJECT_REPONAME",
                        "inline": true
                      },
                      {
                        "name": "Branch",
                        "value": "$CIRCLE_BRANCH",
                        "inline": true
                      },
                      {
                        "name": "Triggered By",
                        "value": "$CIRCLE_USERNAME",
                        "inline": true
                      },
                      {
                        "name": "Commit",
                        "value": "$CIRCLE_SHA1",
                        "inline": false
                      },
                      {
                        "name": "Job Name",
                        "value": "$CIRCLE_JOB",
                        "inline": false
                      },
                      {
                        "name": "Job Status",
                        "value": "$CIRCLE_JOB_STATUS",
                        "inline": false
                      }
                    ],
                    "footer": {
                      "text": "Delta Notifications",
                      "icon_url": "https://avatars.githubusercontent.com/u/12371220?s=280&v=4"
                    },
                    "timestamp": "'"$(date --utc +%Y-%m-%dT%H:%M:%SZ)"'"
                  }]
                }' \
            https://discord.com/api/webhooks/1264668920552489102/MqcqPVMqSGLzA9WX0vNpohv2Hdy7011DDBmDdox3h_RZAAv0OCVKHpCTUGbA5FkH4Qxx

# Orchestrate jobs using workflows
# See: https://circleci.com/docs/workflows/ & https://circleci.com/docs/configuration-reference/#workflows
workflows:
  notify:
    jobs:
      - notify-discord:
          filters:
            branches:
              ignore: []

